
{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mx-auto px-4 py-10">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
        <div class="flex flex-col items-center space-y-6 relative">
            <div class="relative group w-full max-w-[500px] h-[500px] overflow-hidden rounded-xl shadow-lg">
                {% if primary_image %}
                    <img id="mainImage" src="{{ primary_image.image.url }}" 
                         class="w-full h-full rounded-lg object-cover cursor-zoom-in transition-transform duration-300 transform group-hover:scale-105" 
                         alt="{{ product.name }}">  
                {% else %}
                    <div class="w-full h-full bg-gray-200 rounded-lg flex items-center justify-center">
                        <p class="text-gray-500">No image available</p>
                    </div>
                {% endif %}
            </div>
            
            {% if images %}
            <div class="flex space-x-4">
                {% for image in images %}
                <div class="thumbnail-container {% if forloop.first %}active p-1 rounded-lg border-2 border-blue-500{% else %}p-1 rounded-lg border-2 border-transparent hover:border-blue-500{% endif %} cursor-pointer transition-all duration-300">
                    <img src="{{ image.image.url }}" data-src="{{ image.image.url }}" class="thumbnail w-16 h-16 object-cover rounded-md">
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <div class="space-y-8 flex flex-col justify-center">
            <!-- Product Availability -->
            <div>
                <div class="flex items-center space-x-2 mb-2">
                    {% if product.is_active %}
                    <span class="px-3 py-1 text-xs font-semibold text-white bg-green-600 rounded-full">Available</span>
                    {% else %}
                    <span class="px-3 py-1 text-xs font-semibold text-white bg-red-600 rounded-full">Unavailable</span>
                    {% endif %}
                    {% if product.brand and product.brand.offer_percentage > 0 %}
                    <span class="px-3 py-1 text-xs font-semibold text-white bg-blue-600 rounded-full">Special Offer</span>
                    {% endif %}
                </div>
                <h1 class="text-4xl font-bold text-gray-800 leading-tight">{{ product.name }}</h1>
                {% if product.brand %}
                <p class="text-gray-600 mt-1">By {{ product.brand.name }}</p>
                {% endif %}
            </div>
            
            <!-- Rating stars -->
            <div class="flex items-center space-x-2">
                <div class="flex items-center">
                    {% for i in "12345" %}
                        {% with forloop.counter as num %}
                            {% if num <= average_rating %}
                                <span class="text-yellow-500"><i class="fas fa-star"></i></span>
                            {% elif num <= average_rating|add:"0.5" %}
                                <span class="text-yellow-500"><i class="fas fa-star-half-alt"></i></span>
                            {% else %}
                                <span class="text-gray-300"><i class="fas fa-star"></i></span>
                            {% endif %}
                        {% endwith %}
                    {% endfor %}
                </div>
                <span class="text-gray-600 font-medium">{{ average_rating|floatformat:1 }}</span>
                <span class="text-gray-500">({{ product.reviews.count }} reviews)</span>
            </div>
            
            <!-- Description -->
            <div>
                <h3 class="text-lg font-semibold text-gray-700 mb-2">Description</h3>
                <p class="text-gray-600 leading-relaxed">{{ product.description|default:"No description available" }}</p>
                <div class="mt-2">
                    <h4 class="font-medium text-gray-700">Key Features:</h4>
                    <ul class="list-disc pl-5 text-gray-600 mt-1">
                        {% for feature in product_features %}
                            <li>{{ feature }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <div class="mt-4">
                {% if variants.first %}
                    <h4 class="text-xl font-semibold text-gray-700">Price</h4>
                    <div class="flex space-x-4 items-center mt-2">
                        <span class="text-3xl font-bold text-gray-900">₹{{ variants.first.variant_price }}</span>
                        {% if product.brand.offer_percentage > 0 %}
                            {% with discount=product.brand.offer_percentage %}
                                {% with price=variants.first.variant_price %}
                                    {% with original=price|floatformat:2 %}

                                            <span class="text-lg text-gray-400 line-through">₹{{ final }}</span>
                                            <span class="px-2 py-1 text-sm font-semibold text-white bg-red-500 rounded">
                                                {{ discount }}% OFF
                                            </span>
                                        {% endwith %}
                                    {% endwith %}
                                {% endwith %}

                        {% endif %}
                    </div>
                {% else %}
                    <p class="text-red-500">No variants available.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}


<script>
    document.addEventListener("DOMContentLoaded", function () {
        const mainImage = document.getElementById("mainImage");
        const thumbnails = document.querySelectorAll(".thumbnail");
        const thumbnailContainers = document.querySelectorAll(".thumbnail-container");
        const weightOptions = document.querySelectorAll(".weight-option");
        const buyNowBtn = document.getElementById("buyNowBtn");
        const addToCartBtn = document.getElementById("addToCartBtn");
        const stockIndicator = document.getElementById("stockIndicator");
        const stockText = document.getElementById("stockText");
        const priceDisplay = document.querySelector(".text-3xl.font-bold");
        const originalPriceDisplay = document.querySelector(".text-lg.text-gray-400.line-through");
        
        if (thumbnails.length > 0 && mainImage) {
            thumbnailContainers.forEach((container, index) => {
                container.addEventListener("click", () => {
                    thumbnailContainers.forEach(cont => {
                        cont.classList.remove("active", "border-blue-500");
                        cont.classList.add("border-transparent");
                    });
                    container.classList.add("active", "border-blue-500");
                    container.classList.remove("border-transparent");
                    
                    const newSrc = thumbnails[index].dataset.src;
                    mainImage.src = newSrc;
                    mainImage.classList.add("animate-fadeIn");
                    setTimeout(() => mainImage.classList.remove("animate-fadeIn"), 500);
                });
            });
        }
        
        if (weightOptions.length > 0) {
            weightOptions[0]?.classList.add("active");
            
            weightOptions.forEach(option => {
                option.addEventListener("click", function() {
                    weightOptions.forEach(opt => {
                        opt.classList.remove("active", "bg-blue-100", "border-blue-500");
                        opt.classList.add("border-gray-300");
                    });
                    
                    this.classList.add("active", "bg-blue-100", "border-blue-500");
                    this.classList.remove("border-gray-300");
                    
                    const variantId = this.dataset.variantId;
                    const stock = parseInt(this.dataset.stock);
                    const price = this.dataset.price;
                    
                    if (priceDisplay) {
                        priceDisplay.textContent = `₹${price}`;
                    }
                    
                    updateStockDisplay(stock);
                    
                    if (buyNowBtn) buyNowBtn.disabled = stock < 1;
                    if (addToCartBtn) addToCartBtn.disabled = stock < 1;
                    
                    const offerPercentage = {{ product.brand.offer_percentage|default:0 }};
                    if (offerPercentage > 0 && originalPriceDisplay) {
                        const originalPrice = parseFloat(price) * (100 / (100 - offerPercentage));
                        originalPriceDisplay.textContent = `₹${originalPrice.toFixed(2)}`;
                    }
                    
                    // Add animation to price
                    if (priceDisplay) {
                        priceDisplay.classList.add("animate-fadeIn");
                        setTimeout(() => priceDisplay.classList.remove("animate-fadeIn"), 500);
                    }
                });
            });
        }
        
        function updateStockDisplay(stock) {
            if (!stockIndicator || !stockText) return;
            
            if (stock > 10) {
                stockIndicator.style.width = "100%";
                stockText.textContent = `In Stock (${stock} available)`;
                stockIndicator.classList.remove("bg-red-500", "bg-yellow-500");
                stockIndicator.classList.add("bg-green-500");
            } else if (stock > 0) {
                stockIndicator.style.width = `${(stock/10)*100}%`;
                stockText.textContent = `Only ${stock} left!`;
                stockIndicator.classList.remove("bg-red-500", "bg-green-500");
                stockIndicator.classList.add("bg-yellow-500");
            } else {
                stockIndicator.style.width = "0%";
                stockText.textContent = "Out of Stock";
                stockIndicator.classList.remove("bg-green-500", "bg-yellow-500");
                stockIndicator.classList.add("bg-red-500");
            }
        }
        
        /** Add to Cart */
        if (addToCartBtn) {
            addToCartBtn.addEventListener("click", function () {
                if (this.disabled) return;
                
                const activeOption = document.querySelector(".weight-option.active");
                if (!activeOption) return;
                
                const variantId = activeOption.dataset.variantId;
                const stock = parseInt(activeOption.dataset.stock);
                
                if (stock < 1) {
                    showToast("This size is out of stock!", "error");
                    return;
                }
                
                this.classList.add("animate-pulse");
                setTimeout(() => this.classList.remove("animate-pulse"), 500);
                
                
                
                showToast("Added to Cart!", "success");
            });
        }
        
        if (buyNowBtn) {
            buyNowBtn.addEventListener("click", function () {
                if (this.disabled) return;
                
                const activeOption = document.querySelector(".weight-option.active");
                if (!activeOption) return;
                
                const variantId = activeOption.dataset.variantId;
                const stock = parseInt(activeOption.dataset.stock);
                
                if (stock < 1) {
                    showToast("This size is out of stock!", "error");
                    return;
                }
                
                this.classList.add("animate-pulse");
                setTimeout(() => this.classList.remove("animate-pulse"), 500);
                
                window.location.href = `/checkout/?variant=${variantId}`;
            });
        }
        
        /** Show Toast Message */
        function showToast(message, type) {
            const toast = document.createElement("div");
            toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded-lg text-white ${
                type === "success" ? "bg-green-500" : "bg-red-500"
            }`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    });
</script>
