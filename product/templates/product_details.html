{% extends "base.html" %}
{% load static %}

{% block content %}
<head>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .breadcrumb-container {
     background: linear-gradient(145deg, #f9f9f9, #ffffff);
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
  backdrop-filter: blur(5px); 
    }

    .custom-breadcrumb {
      display: flex;
      flex-wrap: wrap;
      list-style: none;
      padding: 0;
      margin: 0;
      gap: 0.5rem;
      align-items: center;
      font-family: "Segoe UI", sans-serif;
      font-size: 15px;
    }

    .custom-breadcrumb li {
      display: flex;
      align-items: center;
    }

    .custom-breadcrumb a {
      text-decoration: none;
      color: #0d6efd;
      font-weight: 500;
      padding: 6px 12px;
      border-radius: 8px;
      transition: all 0.2s ease-in-out;
    }

    .custom-breadcrumb a:hover {
      background: #0d6efd;
      color: white;
    }

    .custom-breadcrumb .separator {
      margin: 0 0.25rem;
      color: #999;
      font-size: 16px;
    }

    .custom-breadcrumb .active {
      font-weight: 600;
      color: #333;
      padding: 6px 12px;
      border-radius: 8px;
      background-color: rgba(0, 0, 0, 0.03);
    }

    .custom-breadcrumb i {
      margin-right: 6px;
    }
  </style>
</head>
<div class="container-fluid">
<div class="d-flex justify-content-start">
  <nav aria-label="breadcrumb">
    <div class="breadcrumb-container ml-1">
      <ol class="custom-breadcrumb">
        <li>
          <a href="/"><i class="bi bi-house-fill"></i>Home</a>
          <span class="separator">‚Ä∫</span>
        </li>
        <li>
          <a href="{% url 'products:list' %}"><i class="bi bi-box-seam"></i>Products</a>
          <span class="separator">‚Ä∫</span>
        </li>
        <li class="active">
          <i class="bi bi-tag-fill"></i>{{ product.name }}
        </li>
      </ol>
    </div>
  </nav>
  </div>
  </div>

        

<div class="container mx-auto px-4 py-8">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
        <div class="flex flex-col items-center space-y-6 relative">
            <div id="gallery-main" class="relative w-full max-w-[500px] h-[500px] overflow-hidden rounded-xl shadow-lg">
                {% if primary_image %}
                    <img id="main-image" src="{{ primary_image.image.url }}" 
                         class="w-full h-full rounded-lg object-cover cursor-zoom-in" 
                         alt="{{ product.name }}">
                    <div id="zoom-lens" class="absolute hidden"></div>
                    <div id="zoom-result" class="absolute hidden"></div>
                    <a href="#" id="zoom-toggle" class="absolute top-4 right-4 text-white bg-black bg-opacity-60 rounded-full p-2 hover:bg-opacity-80 flex items-center justify-center">
                        <i class="fas fa-search-plus text-xl"></i>
                    </a>
                {% else %}  
                    <div class="w-full h-full bg-gray-200 rounded-lg flex items-center justify-center">
                        <p class="text-gray-500">No image available</p>
                    </div>
                {% endif %}
            </div>

             

            <div id="fullscreen-zoom" class="hidden fixed top-0 left-0 w-full h-full bg-black bg-opacity-90 z-50 flex items-center justify-center">
                <img id="fullscreen-image" src="" alt="{{ product.name }} - fullscreen" class="max-w-[80%] max-h-[80%] object-contain">
                <div id="fullscreen-zoom-lens" class="absolute hidden"></div>
                <span id="fullscreen-close" class="absolute top-4 right-4 text-white text-2xl cursor-pointer">√ó</span>
                <span id="fullscreen-prev" class="absolute left-4 top-1/2 transform -translate-y-1/2 text-white text-3xl cursor-pointer">‚Üê</span>
                <span id="fullscreen-next" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-white text-3xl cursor-pointer">‚Üí</span>
            </div>
            
            
            {% if images %}
            <div class="flex space-x-4">
                {% for image in images %}
                <div class="thumb-slide thumbnail-container {% if forloop.first %}active p-1 rounded-lg border-2 border-blue-500{% else %}p-1 rounded-lg border-2 border-transparent hover:border-blue-500{% endif %} cursor-pointer transition-all duration-300">
                    <img src="{{ image.image.url }}" data-src="{{ image.image.url }}" class="thumbnail w-16 h-16 object-cover rounded-md">
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <div class="space-y-6">
            <div>
                <div class="flex items-center space-x-2 mb-2">
                    {% if product.is_active %}
                    <span class="px-3 py-1 text-xs font-semibold text-white bg-green-600 rounded-full">Available</span>
                    {% else %}
                    <span class="px-3 py-1 text-xs font-semibold text-white bg-red-600 rounded-full">Unavailable</span>
                    {% endif %}
                    {% if product.brand and product.brand.offer_percentage > 0 %}
                    <span class="px-3 py-1 text-xs font-semibold text-white bg-blue-600 rounded-full">Special Offer</span>
                    {% endif %}
                </div>
                <h1 class="text-3xl font-bold text-gray-800 leading-tight">{{ product.name }}</h1>
                {% if product.brand %}
                <p class="text-gray-600 mt-1">By {{ product.brand.name }}</p>
                {% endif %}

                  <div class="relative">
            <button 
                        class="wishlist-btn bg-white p-3 rounded-full shadow-md hover:bg-gray-100 hover:shadow-lg transition-all duration-300"
                        onclick="event.stopPropagation(); event.preventDefault(); toggleWishlist({{ product.variants.first.id }})"
                        data-variant-id="{{ product.variants.first.id }}"
                        data-in-wishlist="false"
                    >
                        <i class="far fa-heart text-red-500 text-lg"></i>
                    </button> 
                </div>
            </div>
           

            <div class="flex items-center space-x-2">
                <div class="flex items-center">
                    {% for i in "12345" %}
                        {% with forloop.counter as num %}
                            {% if num <= average_rating %}
                                <span class="text-yellow-500"><i class="fas fa-star"></i></span>
                            {% elif num <= average_rating|add:"0.5" %}
                                <span class="text-yellow-500"><i class="fas fa-star-half-alt"></i></span>
                            {% else %}
                                <span class="text-gray-300"><i class="fas fa-star"></i></span>
                            {% endif %}
                        {% endwith %}
                    {% endfor %}
                </div>
                <span class="text-gray-600 font-medium">{{ average_rating|floatformat:1 }}</span>
                <span class="text-gray-500">({{ product.reviews.count }} reviews)</span>
            </div>
<div>
  <h4 class="text-xl font-semibold text-gray-700">Price</h4>
  <div class="flex items-center space-x-3 mt-2">
    {% with variant=variants.0 %}
      {% if variant.sales_price < variant.variant_price %}
        <span id="variantPrice" class="text-3xl font-bold text-green-700">
          ‚Çπ{{ variant.sales_price }}
        </span>
        <span id="originalPrice" class="text-lg text-gray-400 line-through">
          ‚Çπ{{ variant.variant_price }}
        </span>
        {% comment %} <span class="px-2 py-1 text-sm font-semibold text-white bg-red-500 rounded"> {% endcomment %}
          {% comment %} Save ‚Çπ{{ variant.get_discount_amount }} ({{ variant.get_discount_percentage }}% OFF) {% endcomment %}
        </span>
      {% else %}
        <span id="variantPrice" class="text-3xl font-bold text-gray-900">
          ‚Çπ{{ variant.variant_price }}
        </span>
      {% endif %}
    {% endwith %}
  </div>
</div>


            <div>
                <h3 class="text-lg font-semibold text-gray-700 mb-2">Description</h3>
                <p class="text-gray-600 leading-relaxed">{{ product.description|default:"No description available" }}</p>
                <div class="mt-2">
                    <h4 class="font-medium text-gray-700">Key Features:</h4>
                    <ul class="list-disc pl-5 text-gray-600 mt-1">
                        {% for feature in product_features %}
                            <li>{{ feature }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
<!--  -->

<div class="mt-4">
    <div class="flex justify-between items-center mb-1">
        <span id="stockText" class="text-sm font-medium text-green-600">
            In stock
        </span>
    </div>
    <div class="w-full bg-gray-200 rounded-full h-2">
        <div id="stockIndicator" class="bg-green-500 h-2 rounded-full" style="width: 100%;"></div>
    </div>
</div>

<!-- Variant Selection -->
{% if variants %}
  <div class="mt-6">
    <h4 class="text-xl font-semibold text-gray-700 mb-2">Select Variant</h4>
    <div class="flex flex-wrap gap-3">
      {% for variant in variants %}
        <div
          class="variant-option {% if forloop.first %}bg-blue-100 border-2 border-blue-500{% else %}border-2 border-gray-300 hover:border-blue-300{% endif %} px-4 py-2 rounded-md cursor-pointer transition-all duration-200"
          onclick="selectVariant(this)"
          data-variant-id="{{ variant.id }}"
          data-price="{{ variant.sales_price }}"
          data-original-price="{{ variant.variant_price }}"
          data-discount-amount="{{ variant.get_discount_amount }}"
          data-discount-percentage="{{ variant.get_discount_percentage }}"
          data-stock="{{ variant.quantity_in_stock }}"
        >
          {{ variant.weight }}
        </div>
      {% endfor %}
    </div>
  </div>
{% else %}
  <p class="text-red-500">No variants available.</p>
{% endif %}


           

<input type="hidden" id="selectedVariantId" value="{{ variants.0.id }}">

<div class="mt-6">
    <h4 class="text-lg font-semibold text-gray-700 mb-2">Quantity</h4>
    <div class="flex items-center space-x-2">
        <button id="decreaseQty" class="bg-gray-200 px-3 py-1 rounded-l hover:bg-gray-300">-</button>
        <input type="number" id="quantity" value="1" min="1" max="99" class="quantity-input border text-center w-16 py-1 focus:outline-none">
        <button id="increaseQty" class="bg-gray-200 px-3 py-1 rounded-r hover:bg-gray-300">+</button>
    </div>
</div>


<div class="mt-8 flex space-x-4">
    <button
        id="addToCartBtn"
        type="button"
        onclick="handleAddToCart()"
        class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2 mt-4"
    >
        <i class="fas fa-shopping-cart"></i> Add to Cart
    </button>
</div>


<!-- BUY NOW BUTTON -->
<!--            
             <button id="addToCartBtn"
                    onclick="event.preventDefault(); buyNowBtn({{ variants.0.id }}, document.getElementById('quantity').value)"
                    class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors flex-grow flex items-center justify-center gap-2">
                    <i class="fas fa-shopping-bag"></i> Buy Now
                </button> -->
            

                <!-- <button id="buyNowBtn" 
                    onclick="window.location.href = `/checkout/?variant=${document.querySelector('.variant-option.active').dataset.variantId}&qty=${document.getElementById('quantity').value}`"
                    class="bg-orange-500 text-white px-6 py-3 rounded-lg hover:bg-orange-600 transition-colors flex-grow flex items-center justify-center gap-2">
                    <i class="fas fa-bolt"></i> Buy Now
                </button> -->
            </div>
        </div>
    </div>
</div>

<section class="mb-16">
  <div class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-3xl font-semibold text-gray-800">Similar Products</h2>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
      {% for sp in similar_products %}
        {% if sp.is_active and sp.is_listed %}
        <a href="{% url 'product:detail' sp.slug %}" class="group block">
          <div class="bg-white rounded-lg overflow-hidden shadow hover:shadow-lg transition-transform duration-300 transform hover:-translate-y-1 hover:scale-[1.02]">
            <div class="relative">
              {% if sp.thumbnail %}
              <img src="{{ sp.thumbnail }}" alt="{{ sp.name }}" class="w-full h-60 object-cover">
              {% else %}
              <img src="{% static 'images/placeholder.png' %}" alt="No image available" class="w-full h-60 object-cover">
              {% endif %}

              {% if sp.offer_percentage > 0 %}
              <div class="absolute top-3 left-3 rotate-[-3deg] group-hover:rotate-0 transition-transform">
                <span class="bg-red-600 text-white text-xs font-bold px-2 py-1 rounded">{{ sp.offer_percentage }}% OFF</span>
              </div>
              {% endif %}

              <div class="absolute top-3 right-3 z-10">
                <button 
                  class="wishlist-btn bg-white p-3 rounded-full shadow-md hover:bg-gray-100 hover:shadow-lg transition-all duration-300"
                  onclick="event.stopPropagation(); event.preventDefault(); toggleWishlist({{ sp.variants.first.id }})"
                  data-variant-id="{{ sp.variants.first.id }}"
                  data-in-wishlist="false"
                >
                  <i class="far fa-heart text-red-500 text-lg"></i>
                </button> 
              </div>

              <div class="absolute inset-0 bg-black bg-opacity-20 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center">
                <div class="bg-white bg-opacity-90 px-4 py-2 rounded-md text-sm text-gray-800 font-medium">
                  View Details
                </div>
              </div>
            </div>

            <div class="p-4 space-y-2">
              {% if sp.brand %}
              <p class="text-blue-600 text-xs uppercase font-semibold">{{ sp.brand.name }}</p>
              {% endif %}
              <h3 class="text-base font-semibold text-gray-800 group-hover:text-blue-700 truncate">{{ sp.name }}</h3>

              <div class="flex items-center text-yellow-400 text-sm">
                <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star-half-alt"></i>
                <span class="ml-2 text-gray-500 text-xs">(24)</span>
              </div>

              <div class="flex justify-between items-center pt-2">
                {% with variant=sp.variants.first %}
                  {% if variant %}
                    {% if variant.sales_price < variant.variant_price %}
                      <div class="flex flex-col gap-0.5">
                        <p class="text-lg font-bold text-gray-900">‚Çπ{{ variant.sales_price }}</p>
                        <p class="text-sm line-through text-gray-500">‚Çπ{{ variant.variant_price }}</p>
                        <p class="text-xs text-green-600 font-medium">
                          {% comment %} You save ‚Çπ{{ variant.variant_price|floatformat:0|add:"-"|add:variant.sales_price|floatformat:0 }} {% endcomment %}
                        </p>
                      </div>
                    {% else %}
                      <p class="text-lg font-bold text-gray-900">‚Çπ{{ variant.sales_price }}</p>
                    {% endif %}
                  {% else %}
                    <span class="text-xs bg-gray-200 text-gray-500 px-3 py-1.5 rounded-full">Out of Stock</span>
                  {% endif %}
                {% endwith %}
              </div>
            </div>
          </div>
        </a>
        {% endif %}
      {% endfor %}
    </div>
  </div>
</section>

      

<style>
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    .animate-fadeIn {
        animation: fadeIn 0.3s ease-in-out;
    }

    #gallery-main {
        position: relative;
        cursor: crosshair;
    }

    #main-image {
        width: 100%;
        height: 100%;
        object-fit: contain;
        display: block;
        cursor: zoom-in;
    }

    #zoom-lens {
        width: 100px;
        height: 100px;
        border: 2px solid rgba(59, 130, 246, 0.7);
        background: rgba(59, 130, 246, 0.15);
        pointer-events: none;
    }

    #zoom-result {
        top: 0;
        right: -350;
        width: 1000px;
        height: 1000px;
        border: 2px solid #333;
        background-repeat: no-repeat;
        z-index: 100;
        cursor: crosshair;
        position: absolute;
    }

    #zoom-toggle {
        width: 36px;
        height: 36px;
        transition: all 0.2s ease;
    }

    #zoom-toggle:hover {
        background-color: rgba(0, 0, 0, 0.7);
        transform: scale(1.1);
    }

    #fullscreen-zoom {
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    #fullscreen-image {
        max-width: 80%;
        max-height: 80%;
        object-fit: contain;
    }

    #fullscreen-zoom-lens {
        width: 150px;
        height: 150px;
        border: 2px solid #fff;
        background: rgba(255, 255, 255, 0.2);
        pointer-events: none;
    }

    #fullscreen-close {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    #fullscreen-prev,
    #fullscreen-next {
        padding: 10px;
    }

    .thumbnail-transition {
        transition: all 0.3s ease;
    }
    .thumbnail-active {
        transform: scale(1.1);
         box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    @media (max-width: 991px) {
        #zoom-result {
            display: none !important;
        }
        #zoom-lens {
            display: none !important;
        }
    }

    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
</style>

<script>
   
    let currentImageIndex = 0;

    document.addEventListener('DOMContentLoaded', function() {
        initImageZoom();
        initFullscreenZoom();
        initThumbnails();
    });

    function initThumbnails() {
        const thumbnails = document.querySelectorAll('.thumbnail');
        const thumbnailContainers = document.querySelectorAll('.thumbnail-container');
        const mainImage = document.getElementById('main-image');

        thumbnails.forEach((thumbnail, index) => {
            thumbnail.addEventListener('click', function() {
                const imgSrc = this.getAttribute('data-src');
                if (mainImage && imgSrc) {
                    mainImage.src = imgSrc;
                    currentImageIndex = index;

                    thumbnailContainers.forEach(container => {
                        container.classList.remove('active', 'border-blue-500');
                        container.classList.add('border-transparent');
                    });

                    thumbnailContainers[index].classList.add('active', 'border-blue-500');
                    thumbnailContainers[index].classList.remove('border-transparent');
                }
            });
        });
    }

    function initImageZoom() {
        const container = document.getElementById('gallery-main');
        const mainImage = document.getElementById('main-image');
        const lens = document.getElementById('zoom-lens');
        const result = document.getElementById('zoom-result');
        const zoomToggle = document.getElementById('zoom-toggle');
        
        if (!container || !mainImage || !lens || !result) {
            console.error('Zoom elements not found');
            return;
        }
        
        const zoomLevel = 2;
        const ratioX = zoomLevel
        const ratioY = zoomLevel
        
        container.addEventListener('mouseenter', function(e) {
            if (window.innerWidth >= 992) { // Only on desktop
                lens.style.display = 'block';
                result.style.display = 'block';
                updateZoom(e);
            }
        });
        
        container.addEventListener('mouseleave', function() {
            lens.style.display = 'none';
            result.style.display = 'none';
        });
        
        container.addEventListener('mousemove', updateZoom);
        
        if (zoomToggle) {
            zoomToggle.addEventListener('click', function(e) {
                e.preventDefault();
                openFullscreenZoom();
            });
        }
        
        mainImage.addEventListener('click', function(e) {
            if (window.innerWidth >= 768) {
                e.preventDefault();
                openFullscreenZoom();
            }
        });
        
        function updateZoom(e) {
            if (lens.style.display === 'none') return;
            
            const rect = mainImage.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            if (x < 0 || x > rect.width || y < 0 || y > rect.height) {
                lens.style.display = 'none';
                result.style.display = 'none';
                return;
            }
            
            const lensWidth = lens.offsetWidth;
            const lensHeight = lens.offsetHeight;
            
            let lensX = x - lensWidth / 2;
            let lensY = y - lensHeight / 2;
            
            if (lensX < 0) lensX = 0;
            if (lensY < 0) lensY = 0;
            if (lensX > rect.width - lensWidth) lensX = rect.width - lensWidth;
            if (lensY > rect.height - lensHeight) lensY = rect.height - lensHeight;
            
            lens.style.left = `${lensX}px`;
            lens.style.top = `${lensY}px`;
            
            // const ratioX = result.offsetWidth / lensWidth;
            // const ratioY = result.offsetHeight / lensHeight;
            
            result.style.backgroundImage = `url(${mainImage.src})`;
            result.style.backgroundSize = `${rect.width * zoomLevel}px ${rect.height * zoomLevel}px`;
            result.style.backgroundPosition = `-${lensX * ratioX}px -${lensY * ratioY}px`;
        }
    }

    function initFullscreenZoom() {
        const fullscreenZoom = document.getElementById('fullscreen-zoom');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenLens = document.getElementById('fullscreen-zoom-lens');
        const closeBtn = document.getElementById('fullscreen-close');
        const prevBtn = document.getElementById('fullscreen-prev');
        const nextBtn = document.getElementById('fullscreen-next');
        
        if (!fullscreenZoom || !fullscreenImage || !fullscreenLens || !closeBtn || !prevBtn || !nextBtn) {
            console.error('Fullscreen zoom elements not found');
            return;
        }
        
        closeBtn.addEventListener('click', closeFullscreenZoom);
        
        fullscreenZoom.addEventListener('click', function(e) {
            if (e.target === fullscreenZoom) {
                closeFullscreenZoom();
            }
        });
        
        prevBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            navigateFullscreenImage(-1);
        });
        
        nextBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            navigateFullscreenImage(1);
        });
        
        document.addEventListener('keydown', function(e) {
            if (fullscreenZoom.style.display === 'flex') {
                if (e.key === 'Escape') {
                    closeFullscreenZoom();
                } else if (e.key === 'ArrowLeft') {
                    navigateFullscreenImage(-1);
                } else if (e.key === 'ArrowRight') {
                    navigateFullscreenImage(1);
                }
            }
        });
        
        fullscreenImage.addEventListener('mousemove', function(e) {
            updateFullscreenZoom(e);
        });
        
        fullscreenImage.addEventListener('mouseenter', function() {
            fullscreenLens.style.display = 'block';
        });
        
        fullscreenImage.addEventListener('mouseleave', function() {
            fullscreenLens.style.display = 'none';
        });
        
        function updateFullscreenZoom(e) {
            const rect = fullscreenImage.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            if (x < 0 || x > rect.width || y < 0 || y > rect.height) {
                fullscreenLens.style.display = 'none';
                return;
            }
            
            const lensWidth = fullscreenLens.offsetWidth;
            const lensHeight = fullscreenLens.offsetHeight;
            
            let lensX = x - lensWidth / 2;
            let lensY = y - lensHeight / 2;
            
            if (lensX < 0) lensX = 0;
            if (lensY < 0) lensY = 0;
            if (lensX > rect.width - lensWidth) lensX = rect.width - lensWidth;
            if (lensY > rect.height - lensHeight) lensY = rect.height - lensHeight;
            
            fullscreenLens.style.left = `${lensX}px`;
            fullscreenLens.style.top = `${lensY}px`;
            
            const zoomLevel = 2.5;
            
            fullscreenLens.style.backgroundImage = `url(${fullscreenImage.src})`;
            fullscreenLens.style.backgroundSize = `${rect.width * zoomLevel}px ${rect.height * zoomLevel}px`;
            
            const bgX = (x / rect.width) * 100;
            const bgY = (y / rect.height) * 100;
            fullscreenLens.style.backgroundPosition = `${bgX}% ${bgY}%`;
        }
    }

    function openFullscreenZoom() {
        const fullscreenZoom = document.getElementById('fullscreen-zoom');
        const fullscreenImage = document.getElementById('fullscreen-image');
        
        if (!fullscreenZoom || !fullscreenImage) return;
        
        const mainImage = document.getElementById('main-image');
        if (mainImage) {
            fullscreenImage.src = mainImage.src;
            
            fullscreenZoom.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            const thumbSlides = document.querySelectorAll('.thumb-slide');
            thumbSlides.forEach((slide, index) => {
                if (slide.classList.contains('active')) {
                    currentImageIndex = index;
                }
            });
        }
    }

    function closeFullscreenZoom() {
        const fullscreenZoom = document.getElementById('fullscreen-zoom');
        if (fullscreenZoom) {
            fullscreenZoom.style.display = 'none';
            document.body.style.overflow = '';
        }
    }

    function navigateFullscreenImage(direction) {
        const images = productData.images || [];
        if (images.length <= 1) return;
        
        currentImageIndex = (currentImageIndex + direction + images.length) % images.length;
        
        const fullscreenImage = document.getElementById('fullscreen-image');
        const mainImage = document.getElementById('main-image');
        if (fullscreenImage && images[currentImageIndex]) {
            fullscreenImage.src = images[currentImageIndex].url;
            mainImage.src = images[currentImageIndex].url;
        }
        
        const thumbSlides = document.querySelectorAll('.thumb-slide');
        thumbSlides.forEach((slide, index) => {
            if (index === currentImageIndex) {
                slide.classList.add('active', 'border-blue-500');
                slide.classList.remove('border-transparent');
            } else {
                slide.classList.remove('active', 'border-blue-500');
                slide.classList.add('border-transparent');
            }
        });
    }

    document.addEventListener("DOMContentLoaded", function () {
        const variantOptions = document.querySelectorAll(".variant-option");
        const variantPriceDisplay = document.getElementById("variantPrice");
        const originalPriceDisplay = document.getElementById("originalPrice");
        const stockIndicator = document.getElementById("stockIndicator");
        const stockText = document.getElementById("stockText");

        const quantityInput = document.getElementById("quantity");
        const decreaseQtyBtn = document.getElementById("decreaseQty");
        const increaseQtyBtn = document.getElementById("increaseQty");

        const addToCartBtn = document.getElementById("addToCartBtn");
        const buyNowBtn = document.getElementById("buyNowBtn");

        if (variantOptions.length > 0) {
            variantOptions.forEach(option => {
                option.addEventListener("click", function() {
                    variantOptions.forEach(opt => {
                        opt.classList.remove("active", "bg-blue-100", "border-blue-500");
                        opt.classList.add("border-gray-300");
                    });
                    this.classList.add("active", "bg-blue-100", "border-blue-500");
                    this.classList.remove("border-gray-300");

                    const variantId = this.dataset.variantId;
                    const stock = parseInt(this.dataset.stock);
                    const price = this.dataset.price;

                    if (variantPriceDisplay) {
                        variantPriceDisplay.textContent = `‚Çπ${price}`;
                        variantPriceDisplay.classList.add("animate-fadeIn");
                        setTimeout(() => variantPriceDisplay.classList.remove("animate-fadeIn"), 500);
                    }

                    const offerPercentage = {{ product.brands.offer_percentage|default:0 }};
                    if (offerPercentage > 0 && originalPriceDisplay) {
                        const originalPrice = (parseFloat(price) * 100) / (100 - offerPercentage);
                        originalPriceDisplay.textContent = `‚Çπ${originalPrice.toFixed(2)}`;
                    }

                    updateStockDisplay(stock);

                    buyNowBtn.disabled = stock < 1;
                    addToCartBtn.disabled = stock < 1;

                    if (parseInt(quantityInput.value) > stock) {
                        quantityInput.value = stock > 0 ? stock : 1;
                    }

                    addToCartBtn.onclick = function(event) {
                        event.preventDefault();
                        addCartItem(variantId, quantityInput.value);
                    };

                    buyNowBtn.onclick = function() {
                        window.location.href = `/checkout/?variant=${variantId}&qty=${quantityInput.value}`;
                    };
                });
            });
        }
    
        if (decreaseQtyBtn && increaseQtyBtn && quantityInput) {
            decreaseQtyBtn.addEventListener("click", function() {
                const currentValue = parseInt(quantityInput.value);
                if (currentValue > 1) {
                    quantityInput.value = currentValue - 1;
                }
            });

            increaseQtyBtn.addEventListener("click", function() {
                const currentValue = parseInt(quantityInput.value);
                const activeVariant = document.querySelector(".variant-option.active");
                const maxStock = activeVariant ? parseInt(activeVariant.dataset.stock) : 99;

                if (currentValue < maxStock) {
                    quantityInput.value = currentValue + 1;
                } else {
                    showToast(`Only ${maxStock} items available in stock`, "error");
                }
            });

            quantityInput.addEventListener("change", function() {
                const currentValue = parseInt(this.value);
                const activeVariant = document.querySelector(".variant-option.active");
                const maxStock = activeVariant ? parseInt(activeVariant.dataset.stock) : 99;

                if (currentValue < 1) {
                    this.value = 1;
                } else if (currentValue > maxStock) {
                    this.value = maxStock;
                    showToast(`Only ${maxStock} items available in stock`, "error");
                }
            });
        }

        function updateStockDisplay(stock) {
            if (!stockIndicator || !stockText) return;

            if (stock > 10) {
                stockIndicator.style.width = "100%";
                stockText.textContent = `In stock (${stock} available)`;
                stockText.className = "text-sm font-medium text-green-600";
                stockIndicator.className = "bg-green-500 h-2 rounded-full";
            } else if (stock > 0) {
                stockIndicator.style.width = `${(stock/10)*100}%`;
                stockText.textContent = `Only ${stock} left!`;
                stockText.className = "text-sm font-medium text-yellow-600";
                stockIndicator.className = "bg-yellow-500 h-2 rounded-full";
            } else {
                stockIndicator.style.width = "0%";
                stockText.textContent = "Out of stock";
                stockText.className = "text-sm font-medium text-red-600";
                stockIndicator.className = "bg-red-500 h-2 rounded-full";
            }
        }
    });

  function addCartItem(variantId, quantity) {
    if (!variantId) return;

    fetch(`/cart/add_to_cart/${variantId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            quantity: quantity || 1
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast("Added to Cart!", "success");
            if (data.cart_count !== undefined) {
                const cartCountElement = document.getElementById("cartCount");
                if (cartCountElement) {
                    cartCountElement.textContent = data.cart_count;
                    cartCountElement.classList.add("animate-bounce");
                    setTimeout(() => cartCountElement.classList.remove("animate-bounce"), 1000);
                }
            }
        } else {
            showToast(data.error || "Failed to add to cart", "error");  // Updated to show `error`
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast("An error occurred. Please try again.", "error");
    });
}


    function showToast(message, type) {
        const toast = document.createElement("div");
        toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded-lg text-white z-50 ${
            type === "success" ? "bg-green-500" : "bg-red-500"
        }`;
        toast.textContent = message;
        document.body.appendChild(toast);

        toast.style.opacity = "0";
        toast.style.transform = "translateY(20px)";
        toast.style.transition = "opacity 0.3s, transform 0.3s";

        setTimeout(() => {
            toast.style.opacity = "1";
            toast.style.transform = "translateY(0)";
        }, 10);

        setTimeout(() => {
            toast.style.opacity = "0";
            toast.style.transform = "translateY(20px)";
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
    document.addEventListener("DOMContentLoaded", function () {
    const addToCartBtn = document.getElementById("addToCartBtn");
    addToCartBtn.addEventListener("click", function (event) {
        event.preventDefault();

        const variantId = this.getAttribute("data-variant-id");
        const quantity = document.getElementById("quantity").value;

        // if (!variantId || !quantity) {
        //     showToast("Missing variant or quantity", "error");
        //     return;
        // }

        addCartItem(parseInt(variantId), parseInt(quantity));
    });
});

</script>
<script>
    function selectVariant(element) {
        const variantId = element.dataset.variantId;
        const stock = parseInt(element.dataset.stock);

        document.getElementById('selectedVariantId').value = variantId;

        // Update visual selection
        document.querySelectorAll('.variant-option').forEach(el => {
            el.classList.remove('bg-blue-100', 'border-blue-500');
            el.classList.add('border-gray-300');
        });
        element.classList.add('bg-blue-100', 'border-blue-500');
        element.classList.remove('border-gray-300');

        // Update stock indicator
        const stockText = document.getElementById('stockText');
        const stockIndicator = document.getElementById('stockIndicator');

        if (stock > 10) {
            stockText.textContent = `In stock (${stock} available)`;
            stockText.className = "text-sm font-medium text-green-600";
            stockIndicator.style.width = "100%";
            stockIndicator.className = "bg-green-500 h-2 rounded-full";
        } else if (stock > 0) {
            stockText.textContent = `Only ${stock} left!`;
            stockText.className = "text-sm font-medium text-yellow-600";
            stockIndicator.style.width = `${stock * 10}%`;
            stockIndicator.className = "bg-yellow-500 h-2 rounded-full";
        } else {
            stockText.textContent = "Out of stock";
            stockText.className = "text-sm font-medium text-red-600";
            stockIndicator.style.width = "0%";
            stockIndicator.className = "bg-red-500 h-2 rounded-full";
        }

        // üîÑ Update price display
        const price = parseFloat(element.dataset.price);
        const originalPrice = parseFloat(element.dataset.originalPrice);
        const discountAmount = parseFloat(element.dataset.discountAmount);
        const discountPercent = parseFloat(element.dataset.discountPercentage);

        const variantPriceEl = document.getElementById('variantPrice');
        const originalPriceEl = document.getElementById('originalPrice');
        const discountBadgeEl = document.getElementById('discountBadge');

        if (price < originalPrice) {
            variantPriceEl.textContent = `‚Çπ${price}`;
            originalPriceEl.textContent = `‚Çπ${originalPrice}`;
            originalPriceEl.classList.remove('hidden');

            if (discountBadgeEl) {
                discountBadgeEl.textContent = `Save ‚Çπ${discountAmount} (${discountPercent}% OFF)`;
                discountBadgeEl.classList.remove('hidden');
            }
        } else {
            variantPriceEl.textContent = `‚Çπ${originalPrice}`;
            originalPriceEl.classList.add('hidden');
            if (discountBadgeEl) discountBadgeEl.classList.add('hidden');
        }
    }

 function handleAddToCart() {
    const variantId = document.getElementById('selectedVariantId').value;
    const quantity = document.getElementById('quantity').value;

    if (!variantId) {
        showToast("Please select a variant first.", "error");
        return;
    }

    fetch(`/cart/add_to_cart/${variantId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ quantity: quantity || 1 })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast("Added to Cart!", "success");

            const cartCount = document.getElementById("cartCount");
            if (cartCount) {
                cartCount.textContent = data.cart_count;
                cartCount.classList.add("animate-bounce");
                setTimeout(() => cartCount.classList.remove("animate-bounce"), 1000);
            }

            // ‚úÖ Remove from wishlist (if it's in wishlist)
            const heart = document.getElementById('heart-' + variantId);
            if (heart) {
                heart.classList.remove('fas', 'text-red-500');
                heart.classList.add('far', 'text-gray-400');
            }

            updateCounts(); // ‚úÖ update wishlist + cart badge
        } else {
            showToast(data.error || "Failed to add to cart", "error");
        }
    })
    .catch(err => {
        console.error("Add to cart failed", err);
        showToast("Something went wrong", "error");
    });
}

    
    document.addEventListener("DOMContentLoaded", () => {
        const firstVariant = document.querySelector('.variant-option');
        if (firstVariant) {
            selectVariant(firstVariant);
        }
    });
</script>

<script>
function getCSRFToken() {
    const cookieValue = document.cookie
        .split('; ')
        .find(row => row.startsWith('csrftoken='))
        ?.split('=')[1];
    return cookieValue;
}

function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toast-container');
    if (!toastContainer) return;

    const toast = document.createElement('div');
    toast.className = `rounded-lg py-3 px-4 shadow-lg flex items-center space-x-3 mb-3 transform transition-all duration-300 ease-out translate-y-10 opacity-0`;

    if (type === 'success') toast.classList.add('bg-green-600', 'text-white');
    else if (type === 'error') toast.classList.add('bg-red-600', 'text-white');
    else toast.classList.add('bg-blue-600', 'text-white');

    const icon = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        info: 'fa-info-circle'
    }[type] || 'fa-info-circle';

    toast.innerHTML = `<i class="fas ${icon}"></i><span>${message}</span>`;
    toastContainer.appendChild(toast);

    setTimeout(() => toast.classList.remove('translate-y-10', 'opacity-0'), 10);
    setTimeout(() => {
        toast.classList.add('translate-y-10', 'opacity-0');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function updateLocalWishlistTracking(variantId, isInWishlist) {
    try {
        let wishlist = JSON.parse(localStorage.getItem('userWishlist') || '[]');
        if (isInWishlist && !wishlist.includes(variantId)) {
            wishlist.push(variantId);
        } else if (!isInWishlist) {
            wishlist = wishlist.filter(id => id !== variantId);
        }
        localStorage.setItem('userWishlist', JSON.stringify(wishlist));
    } catch (e) {
        console.error('Local wishlist error:', e);
    }
}

async function toggleWishlist(variantId) {
    try {
        const button = document.querySelector(`.wishlist-btn[data-variant-id="${variantId}"]`);
        if (!button) return;

        const isInWishlist = button.getAttribute('data-in-wishlist') === 'true';
        const url = isInWishlist ? `/wishlist/remove/${variantId}/` : `/wishlist/add/${variantId}/`;

        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin text-lg"></i>';

        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            credentials: 'same-origin'
        });

        const data = await response.json();
        if (response.ok && data.success) {
            const newState = !isInWishlist;
            document.querySelectorAll(`.wishlist-btn[data-variant-id="${variantId}"]`).forEach(btn => {
                btn.setAttribute('data-in-wishlist', newState.toString());
                btn.innerHTML = newState
                    ? '<i class="fas fa-heart text-red-500 text-lg"></i>'
                    : '<i class="far fa-heart text-red-500 text-lg"></i>';
                btn.disabled = false;
            });
            updateLocalWishlistTracking(variantId, newState);
            showToast(newState ? 'Added to wishlist' : 'Removed from wishlist', 'success');
        } else {
            throw new Error(data.error || 'Wishlist update failed');
        }

    } catch (error) {
        console.error(error);
        if (error.message.includes('authentication')) {
            window.location.href = '/accounts/login/?next=' + window.location.pathname;
        } else {
            showToast('Failed to update wishlist', 'error');
        }
    }
}

async function checkWishlistStatus() {
    try {
        const response = await fetch("/wishlist/status/", {
            method: 'GET',
            headers: { 'Accept': 'application/json' },
            credentials: 'same-origin'
        });

        const wishlistItems = new Set();
        if (response.ok) {
            const data = await response.json();
            data.items?.forEach(id => wishlistItems.add(parseInt(id)));
            localStorage.setItem('userWishlist', JSON.stringify([...wishlistItems]));
        }

        document.querySelectorAll('.wishlist-btn').forEach(btn => {
            const variantId = parseInt(btn.getAttribute('data-variant-id'));
            const isInWishlist = wishlistItems.has(variantId);
            btn.setAttribute('data-in-wishlist', isInWishlist.toString());
            btn.innerHTML = isInWishlist
                ? '<i class="fas fa-heart text-red-500 text-lg"></i>'
                : '<i class="far fa-heart text-red-500 text-lg"></i>';
        });
    } catch {
        console.warn('Falling back to local wishlist');
        const local = JSON.parse(localStorage.getItem('userWishlist') || '[]');
        const localSet = new Set(local.map(id => parseInt(id)));

        document.querySelectorAll('.wishlist-btn').forEach(btn => {
            const variantId = parseInt(btn.getAttribute('data-variant-id'));
            const isInWishlist = localSet.has(variantId);
            btn.setAttribute('data-in-wishlist', isInWishlist.toString());
            btn.innerHTML = isInWishlist
                ? '<i class="fas fa-heart text-red-500 text-lg"></i>'
                : '<i class="far fa-heart text-red-500 text-lg"></i>';
        });
    }
}

document.addEventListener('DOMContentLoaded', checkWishlistStatus);
</script>


{% endblock %}