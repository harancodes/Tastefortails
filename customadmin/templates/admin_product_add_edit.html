{% extends 'admin_base.html' %}
{% load static %}

{% block extrastyle %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  .main-content {
    padding: 20px;
  }
  .breadcrumb {
    padding: 10px 0;
    margin-bottom: 20px;
  }
  .product-card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
  }
  .upload-box {
    border: 2px dashed #ccc;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  .upload-box:hover {
    background-color: #f8f9fa;
  }
  .main-photo {
    height: 200px;
  }
  .other-photo {
    height: 100px;
  }
  .upload-icon {
    font-size: 24px;
    color: #6c757d;
    margin-bottom: 10px;
  }
  .submit-btn {
    background-color: #6610f2;
    border-color: #6610f2;
  }
  .submit-btn:hover {
    background-color: #5b09d6;
    border-color: #5b09d6;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <!-- Main Content -->
    <div class="col-12 main-content">
      <!-- Breadcrumbs -->
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="#">Dashboard</a></li>
          <li class="breadcrumb-item"><a href="#">Product</a></li>
          <li class="breadcrumb-item active" aria-current="page">Add Product</li>
        </ol>
      </nav>
      
      <form method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        
        <!-- Product Details Section -->
        <div class="product-card">
          <h3 class="mb-3">Add Product</h3>
          
          <div class="mb-3">
            <label for="product-name" class="form-label">Product name</label>
            <input type="text" class="form-control" id="product-name" name="name" placeholder="Enter product name" required>
          </div>
          
          <div class="mb-3">
            <label for="product-description" class="form-label">Product Description</label>
            <textarea class="form-control" id="product-description" name="description" rows="4" placeholder="Enter product description"></textarea>
          </div>
          
          <div class="mb-3">
            <label for="select-category" class="form-label">Select Category</label>
            <select class="form-select" id="select-category" name="category" required>
              <option selected disabled value="">Select category</option>
              {% for category in categories %}
                {% if category.is_active and category.is_listed %}
                  <option value="{{ category.id }}">{{ category.name }}</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>
          
          <div class="mb-3">
            <label for="select-brand" class="form-label">Brand</label>
            <select class="form-select" id="select-brand" name="brand">
              <option selected disabled value="">Select brand</option>
              {% for brand in brands %}
                <option value="{{ brand.id }}">{{ brand.name }}</option>
              {% endfor %}
            </select>
          </div>
          
          <div class="mb-3">
            <label for="select-type" class="form-label">Type</label>
            <select class="form-select" id="select-type" name="product_type" required>
              <option selected disabled value="">Select type</option>
              <option value="dry">Dry</option>
              <option value="wet">Wet</option>
              <option value="gravy">Gravy</option>
              <option value="milk_replacers">Milk Replacers</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label for="product-stock" class="form-label">Stock</label>
            <input type="number" class="form-control" id="product-stock" name="stock" min="0" required>
          </div>
          
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="is-active" name="is_active" checked>
            <label class="form-check-label" for="is-active">Is Active</label>
          </div>
          
          <div class="mb-3">
            <button type="button" class="btn btn-outline-primary" onclick="addVariantRow()">
              + Add Variant
            </button>
          </div>
          
          <div id="variantContainer"></div>
          
          <table class="table" id="variantTable" style="display:none;">
            <thead>
              <tr>
                <th>Weight</th>
                <th>Price (₹)</th>
                <th>Stock</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          
          <script>
            function addVariantRow() {
              const container = document.getElementById('variantContainer');
              const index = container.children.length;
              const row = document.createElement('div');
              row.className = 'row align-items-end mb-3';
              row.innerHTML = `
                <div class="col-md-3">
                  <label class="form-label">Weight</label>
                  <input type="text" name="variants_weight[]" class="form-control" placeholder="e.g. 1kg" required>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Price (₹)</label>
                  <input type="number" name="variants_price[]" class="form-control" step="0.01" placeholder="e.g. 599" required>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Stock</label>
                  <input type="number" name="variants_stock[]" class="form-control" placeholder="e.g. 100" required>
                </div>
                <div class="col-md-3">
                  <button type="button" class="btn btn-danger mt-4" onclick="removeVariantRow(this)">Remove</button>
                </div>
              `;
              container.appendChild(row);
              updateVariantTable();
            }
            
            function removeVariantRow(button) {
              const row = button.closest('.row');
              row.remove();
              updateVariantTable();
            }
            
            function updateVariantTable() {
              const weights = document.getElementsByName('variants_weight[]');
              const prices = document.getElementsByName('variants_price[]');
              const stocks = document.getElementsByName('variants_stock[]');
              const table = document.getElementById('variantTable');
              const tbody = table.querySelector('tbody');
              tbody.innerHTML = '';
              
              let hasData = false;
              for (let i = 0; i < weights.length; i++) {
                if (weights[i].value.trim() === '') continue;
                hasData = true;
                const row = document.createElement('tr');
                row.innerHTML = `
                  <td>${weights[i].value}</td>
                  <td>${prices[i].value}</td>
                  <td>${stocks[i].value}</td>
                  <td><button type="button" class="btn btn-sm btn-danger" onclick="removeVariantRow(this)">Remove</button></td>
                `;
                tbody.appendChild(row);
              }
              
              table.style.display = hasData ? 'table' : 'none';
            }
            
            document.addEventListener('input', function (e) {
              if (e.target.name && e.target.name.startsWith('variants_')) {
                updateVariantTable();
              }
            });
          </script>
        </div>
        
        <!-- Add Product Image Section -->
        <div class="product-card">
          <h5 class="mb-3">Add Product Image</h5>
          <div class="row">
            <!-- Main Image Upload -->
            <div class="col-md-6 mb-3 d-flex align-items-center justify-content-center">
              <div class="upload-box main-photo text-center p-4 border rounded w-100 h-100 d-flex flex-column align-items-center justify-content-center" onclick="document.getElementById('main-image-upload').click();">
                <div class="upload-icon mb-2">
                  <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-cloud-arrow-up" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M7.646 5.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 6.707V10.5a.5.5 0 0 1-1 0V6.707L6.354 7.854a.5.5 0 1 1-.708-.708l2-2z"/>
                    <path d="M4.406 3.342A5.53 5.53 0 0 1 8 2c2.69 0 4.923 2 5.166 4.579C14.758 6.804 16 8.137 16 9.773 16 11.569 14.502 13 12.687 13H3.781C1.708 13 0 11.366 0 9.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383z"/>
                  </svg>
                </div>
                <p class="mb-2">Drag & drop your main image or browse</p>
                <button type="button" class="btn btn-sm btn-outline-secondary">Browse</button>
                <input type="file" name="main_image" class="d-none" id="main-image-upload" accept="image/*">
              </div>
            </div>
            
            <!-- Other Images Upload -->
            <div class="col-md-6 mb-3">
              <div class="row h-100">
                {% for i in "123" %}
                <div class="col-md-4 mb-3 d-flex align-items-center justify-content-center">
                  <div class="upload-box other-photo text-center p-3 border rounded w-100 h-100 d-flex flex-column align-items-center justify-content-center" onclick="document.getElementById('other-image-{{ forloop.counter }}').click();">
                    <div class="upload-icon mb-2">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-image" viewBox="0 0 16 16">
                        <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                        <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12z"/>
                      </svg>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-secondary">Browse</button>
                    <input type="file" name="other_image_{{ forloop.counter }}" class="d-none" id="other-image-{{ forloop.counter }}" accept="image/*">
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
        
        <!-- Submit Buttons -->
        <div class="d-flex justify-content-end mt-4">
          <button type="reset" class="btn btn-light me-2">Cancel</button>
          <button type="submit" class="btn btn-primary submit-btn">Add Product</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // Image preview logic
  document.querySelectorAll('.upload-box').forEach(box => {
    box.addEventListener('click', function() {
      const fileInput = this.querySelector('input[type="file"]');
      if (fileInput) {
        fileInput.click();
      }
    });

    const fileInput = box.querySelector('input[type="file"]');
    if (fileInput) {
      fileInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
          const reader = new FileReader();
          reader.onload = function(e) {
            let img = box.querySelector('img');
            if (!img) {
              img = document.createElement('img');
              img.classList.add('img-fluid', 'mb-2');
              img.style.maxHeight = box.classList.contains('main-photo') ? '150px' : '70px';
              const icon = box.querySelector('.upload-icon');
              const text = box.querySelector('p');
              if (icon) icon.remove();
              if (text) text.remove();
              box.insertBefore(img, box.firstChild);
            }
            img.src = e.target.result;
          };
          reader.readAsDataURL(this.files[0]);
        }
      });
    }
  });
</script>
{% endblock %}
