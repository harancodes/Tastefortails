{% extends 'admin_base.html' %}

{% block admin_side %}
<div class="max-w-7xl mx-auto p-4 sm:p-6 bg-white shadow-lg rounded-lg">
    <!-- Page Title -->
    <h1 class="text-2xl font-bold mb-6">Variants for {{ product.name }}</h1>

    <!-- Add Variant Button -->
    <button onclick="openAddVariantModal()" class="mb-6 px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition duration-200">
        Add New Variant
    </button>

    <!-- Variants Table -->
    <div class="overflow-x-auto">
        <table class="min-w-full border border-gray-200 rounded-lg overflow-hidden">
            <thead class="bg-gray-100">
                <tr>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Color</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Stock</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for variant in variants %}
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-gray-700 font-medium">{{ variant.color }}</td>
                    <td class="px-4 py-3 text-gray-600">{{ variant.stock }}</td>
                    <td class="px-4 py-3">
                        <div class="flex space-x-4">
                            <button 
                                onclick="openEditVariantModal('{{ variant.id }}', '{{ variant.color }}', '{{ variant.stock }}')" 
                                class="text-blue-600 hover:underline">
                                Edit
                            </button>
                            <button 
                                onclick="deleteVariant('{{ variant.id }}')" 
                                class="text-red-500 hover:underline">
                                Delete
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="3" class="text-center text-gray-600 py-4">No variants found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>


    </div>




    </div>
                    <!-- Pagination -->
                    <div class="mt-6 flex justify-center">
    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
        {% if variants.has_previous %}
            <a href="?page={{ variants.previous_page_number }}" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                <span class="sr-only">Previous</span>
                <!-- Heroicon name: solid/chevron-left -->
                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                </svg>
            </a>
        {% endif %}

        {% for num in variants.paginator.page_range %}
            {% if variants.number == num %}
                <a href="?page={{ num }}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-blue-500 text-white text-sm font-medium">
                    {{ num }}
                </a>
            {% else %}
                <a href="?page={{ num }}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                    {{ num }}
                </a>
            {% endif %}
        {% endfor %}

        {% if variants.has_next %}
            <a href="?page={{ variants.next_page_number }}" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                <span class="sr-only">Next</span>
                <!-- Heroicon name: solid/chevron-right -->
                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                </svg>
            </a>add_product
        {% endif %}
    </nav>
    <!-- Add Variant Modal -->
    <div id="addVariantModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
            <h2 class="text-xl font-bold mb-4">Add New Variant</h2>
            <form id="addVariantForm" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="action" value="add">
                <div class="space-y-4">
                    <input type="text" name="color" placeholder="Color" class="w-full border border-gray-300 p-2 rounded" required>
                    <input type="number" name="stock" placeholder="Stock" class="w-full border border-gray-300 p-2 rounded" required>
                    <input type="file" name="image1" class="w-full border border-gray-300 p-2 rounded" accept="image/*">
                    <input type="file" name="image2" class="w-full border border-gray-300 p-2 rounded" accept="image/*">
                    <input type="file" name="image3" class="w-full border border-gray-300 p-2 rounded" accept="image/*">
                    <input type="file" name="image4" class="w-full border border-gray-300 p-2 rounded" accept="image/*">
                </div>
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" onclick="closeAddVariantModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                        Add Variant
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="imageCropperModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z--5=100">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl p-6">
            <h2 class="text-xl font-bold mb-4">Crop Image</h2>
            <div class="flex">
                <div class="w-3/4 pr-4">
                    <img id="cropperImage" class="max-w-full" src="" alt="Image to crop">
                </div>
                <div class="w-1/4">
                    <div class="preview-container overflow-hidden"></div>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button type="button" onclick="closeCropperModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">
                    Cancel
                </button>
                <button type="button" onclick="confirmCrop()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                    Confirm Crop
                </button>
            </div>
        </div>
    </div>



    <!-- Edit Variant Modal -->
    <div id="editVariantModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
            <h2 class="text-xl font-bold mb-4">Edit Variant</h2>
            <form id="editVariantForm" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="action" value="edit">
                <input type="hidden" name="variant_id" id="editVariantId">
                <div class="space-y-4">
                    <input type="text" name="color" id="editVariantColor" placeholder="Color" class="w-full border border-gray-300 p-2 rounded" required>
                    <input type="number" name="stock" id="editVariantStock" placeholder="Stock" class="w-full border border-gray-300 p-2 rounded" required>
                    <input type="file" name="image1" class="w-full border border-gray-300 p-2 rounded" accept="image/*">
                    <input type="file" name="image2" class="w-full border border-gray-300 p-2 rounded" accept="image/*">
                    <input type="file" name="image3" class="w-full border border-gray-300 p-2 rounded" accept="image/*">
                    <input type="file" name="image4" class="w-full border border-gray-300 p-2 rounded" accept="image/*">
                </div>
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" onclick="closeEditVariantModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                        Update Variant
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    const productId = {{ product.id }};

    // Add Variant Modal Functions
    function openAddVariantModal() {
        document.getElementById('addVariantModal').classList.remove('hidden');
    }

    function closeAddVariantModal() {
        document.getElementById('addVariantModal').classList.add('hidden');
    }

    // Edit Variant Modal Functions
    function openEditVariantModal(variantId, color, stock) {
        document.getElementById('editVariantId').value = variantId;
        document.getElementById('editVariantColor').value = color;
        document.getElementById('editVariantStock').value = stock;
        document.getElementById('editVariantModal').classList.remove('hidden');
    }

    function closeEditVariantModal() {
        document.getElementById('editVariantModal').classList.add('hidden');
    }

    // Delete Variant Function
    async function deleteVariant(variantId) {
        if (!confirm('Are you sure you want to delete this variant?')) return;

        try {
            const response = await fetch(`/admin-panel/variants/${variantId}/delete/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Failed to delete variant');

            alert(data.message);
            window.location.reload();
        } catch (error) {
            console.error('Error deleting variant:', error);
            alert(error.message || 'An error occurred while deleting the variant');
        }
    }

    // Form Submission Handlers
    document.getElementById('addVariantForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        await submitForm(e.target, `/admin-panel/products/${productId}/variants/add/`);
    });

    document.getElementById('editVariantForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const variantId = document.getElementById('editVariantId').value;
        await submitForm(e.target, `/admin-panel/variants/${variantId}/edit/`);
    });

    async function submitForm(form, url) {
        try {
            const formData = new FormData(form);
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            });

            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Failed to process request');

            alert(data.message);
            window.location.reload();
        } catch (error) {
            console.error('Error:', error);
            alert(error.message || 'An error occurred');
        }
    }

    // Utility Function to Get CSRF Token
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    let currentCropper = null;
    let currentFileInput = null;

    // Modify file input to trigger cropping
    function setupImageCropping(fileInput) {
        const file = fileInput.files[0];
        if (!file) return;

        // Close any open modals to prevent stacking
        closeAddVariantModal();
        closeEditVariantModal();

        currentFileInput = fileInput;
        const reader = new FileReader();
        reader.onload = function(e) {
            const cropperImage = document.getElementById('cropperImage');
            cropperImage.src = e.target.result;
            
            // Close any existing cropper
            if (currentCropper) {
                currentCropper.destroy();
            }

            // Open cropper modal
            document.getElementById('imageCropperModal').classList.remove('hidden');

            // Initialize cropper
            currentCropper = new Cropper(cropperImage, {
                aspectRatio: 1, // Square crop
                viewMode: 1,
                preview: '.preview-container'
            });
        };
        reader.readAsDataURL(file);
    }

    function confirmCrop() {
        if (currentCropper && currentFileInput) {
            // Get cropped canvas
            const croppedCanvas = currentCropper.getCroppedCanvas({
                width: 500, // Set a standard width
                height: 500  // Set a standard height
            });

            // Convert canvas to blob
            croppedCanvas.toBlob(function(blob) {
                // Create a new File object with the cropped image
                const croppedFile = new File([blob], 'cropped_image.jpg', {
                    type: 'image/jpeg'
                });

                // Replace the original file in the input
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(croppedFile);
                currentFileInput.files = dataTransfer.files;

                // Close cropper
                closeCropperModal();

                // Reopen the original modal
                if (currentFileInput.closest('#addVariantModal')) {
                    openAddVariantModal();
                } else if (currentFileInput.closest('#editVariantModal')) {
                    const variantId = document.getElementById('editVariantId').value;
                    const color = document.getElementById('editVariantColor').value;
                    const stock = document.getElementById('editVariantStock').value;
                    openEditVariantModal(variantId, color, stock);
                }
            }, 'image/jpeg');
        }
    }

    function closeCropperModal() {
        document.getElementById('imageCropperModal').classList.add('hidden');
        if (currentCropper) {
            currentCropper.destroy();
            currentCropper = null;
        }
    }

    // Modify existing file inputs to use cropping
    document.querySelectorAll('input[type="file"]').forEach(fileInput => {
        fileInput.addEventListener('change', function() {
            setupImageCropping(this);
        });
    });
</script>

{% endblock %}