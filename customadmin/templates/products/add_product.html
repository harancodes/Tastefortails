{% extends 'admin_base.html' %}

{% block content %}

<!-- Load Cropper.js -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<div class="container mt-4">
    <h2>Add Product</h2>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %} 

    <form method="POST" enctype="multipart/form-data" id="productForm">
        {% csrf_token %}

        <div class="mb-3">
            <label for="name" class="form-label">Product Name *</label>
            <input type="text" name="name" id="name" class="form-control" required>
        </div>

        <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <textarea name="description" id="description" class="form-control"></textarea>
        </div>

        <div class="mb-3">
            <label for="category" class="form-label">Category *</label>
            <select name="category" id="category" class="form-control" required>
                <option value="">Select a category</option>
                {% for cat in categories %}
                    <option value="{{ cat.id }}">{{ cat.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3">
            <label for="brand" class="form-label">Brand (Optional)</label>
            <select name="brand" id="brand" class="form-control">
                <option value="">Select a brand</option>
                {% for brand in brands %}
                    <option value="{{ brand.id }}">{{ brand.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3">
            <label for="product_type" class="form-label">Product Type *</label>
            <select name="product_type" id="product_type" class="form-control" required>
                <option value="">Select a type</option>
                <option value="dry">Dry</option>
                <option value="wet">Wet</option>
                <option value="gravy">Gravy</option>
                <option value="milk_replacers">Milk Replacers</option>
            </select>
        </div>

        <hr>
        <h5>Variants</h5>
        <div id="variant-section">
            <div class="variant-group mb-2 d-flex gap-2 align-items-center">
                <input type="text" name="variants_weight[]" placeholder="Weight (e.g., 500g)" class="form-control w-25" required>
                <input type="number" name="variants_price[]" placeholder="Price" class="form-control w-25" step="0.01" min="0" required>
                <input type="number" name="variants_stock[]" placeholder="Stock" class="form-control w-25" min="0" required>
                <button type="button" class="btn btn-danger btn-sm remove-variant">Remove</button>
            </div>
        </div>
        <button type="button" class="btn btn-secondary btn-sm" id="add-variant">+ Add Variant</button>

        <hr>
        <h5>Product Images</h5>

        <!-- Croppable Main Image -->
        <div class="mb-3">
            <label class="form-label">Main Image * (crop before submit)</label>
            <input type="file" id="mainImageInput" accept="image/*" class="form-control" required>
            <div class="mt-3" id="mainImageContainer" style="display: none;">
                <img id="mainImagePreview" style="max-width: 100%;" />
                <div class="mt-2">
                    <button type="button" class="btn btn-primary btn-sm" id="cropMainImage">Crop Main Image</button>
                </div>
            </div>
            <div class="mt-2" id="mainImageCroppedContainer" style="display: none;">
                <p class="text-success">Image cropped successfully!</p>
                <img id="mainImageCroppedPreview" style="max-width: 100%; max-height: 300px;" />
                <input type="hidden" name="main_image_data" id="mainImageData">
            </div>
        </div>

        <!-- Other Images (Crop Enabled) -->
        <div class="mb-3">
            <label class="form-label">Other Images (optional)</label>
            
            <!-- Other Image 1 -->
            <div class="mb-3">
                <input type="file" id="otherImageInput1" accept="image/*" class="form-control mb-2">
                <div class="mt-2" id="otherImageContainer1" style="display: none;">
                    <img id="otherImagePreview1" style="max-width: 100%;" />
                    <div class="mt-2">
                        <button type="button" class="btn btn-primary btn-sm" id="cropOtherImage1">Crop Image</button>
                    </div>
                </div>
                <div class="mt-2" id="otherImageCroppedContainer1" style="display: none;">
                    <p class="text-success">Image cropped successfully!</p>
                    <img id="otherImageCroppedPreview1" style="max-width: 100%; max-height: 200px;" />
                    <input type="hidden" name="other_image_data_1" id="otherImageData1">
                </div>
            </div>

            <!-- Other Image 2 -->
            <div class="mb-3">
                <input type="file" id="otherImageInput2" accept="image/*" class="form-control mb-2">
                <div class="mt-2" id="otherImageContainer2" style="display: none;">
                    <img id="otherImagePreview2" style="max-width: 100%;" />
                    <div class="mt-2">
                        <button type="button" class="btn btn-primary btn-sm" id="cropOtherImage2">Crop Image</button>
                    </div>
                </div>
                <div class="mt-2" id="otherImageCroppedContainer2" style="display: none;">
                    <p class="text-success">Image cropped successfully!</p>
                    <img id="otherImageCroppedPreview2" style="max-width: 100%; max-height: 200px;" />
                    <input type="hidden" name="other_image_data_2" id="otherImageData2">
                </div>
            </div>

            <!-- Other Image 3 -->
            <div class="mb-3">
                <input type="file" id="otherImageInput3" accept="image/*" class="form-control mb-2">
                <div class="mt-2" id="otherImageContainer3" style="display: none;">
                    <img id="otherImagePreview3" style="max-width: 100%;" />
                    <div class="mt-2">
                        <button type="button" class="btn btn-primary btn-sm" id="cropOtherImage3">Crop Image</button>
                    </div>
                </div>
                <div class="mt-2" id="otherImageCroppedContainer3" style="display: none;">
                    <p class="text-success">Image cropped successfully!</p>
                    <img id="otherImageCroppedPreview3" style="max-width: 100%; max-height: 200px;" />
                    <input type="hidden" name="other_image_data_3" id="otherImageData3">
                </div>
            </div>
        </div>

        <div id="responseMessage"></div>

        <button type="submit" class="btn btn-primary">Add Product</button>
    </form>
</div>

<!-- Variant Logic -->
<script>
    document.getElementById('add-variant').addEventListener('click', function () {
        const variantGroup = document.createElement('div');
        variantGroup.classList.add('variant-group', 'mb-2', 'd-flex', 'gap-2', 'align-items-center');
        variantGroup.innerHTML = `
            <input type="text" name="variants_weight[]" placeholder="Weight (e.g., 500g)" class="form-control w-25" required>
            <input type="number" name="variants_price[]" placeholder="Price" class="form-control w-25" step="0.01" min="0" required>
            <input type="number" name="variants_stock[]" placeholder="Stock" class="form-control w-25" min="0" required>
            <button type="button" class="btn btn-danger btn-sm remove-variant">Remove</button>
        `;
        document.getElementById('variant-section').appendChild(variantGroup);
    });

    document.addEventListener('click', function (e) {
        if (e.target.classList.contains('remove-variant')) {
            const variantGroups = document.querySelectorAll('.variant-group');
            if (variantGroups.length > 1) {
                e.target.parentElement.remove();
            } else {
                alert('At least one variant is required.');
            }
        }
    });
</script>

<!-- Image Cropping Scripts -->
<script>
    // Main Image Processing
    let mainCropper = null;
    const mainImageInput = document.getElementById('mainImageInput');
    const mainImagePreview = document.getElementById('mainImagePreview');
    const mainImageContainer = document.getElementById('mainImageContainer');
    const mainImageCroppedContainer = document.getElementById('mainImageCroppedContainer');
    const mainImageCroppedPreview = document.getElementById('mainImageCroppedPreview');
    const mainImageData = document.getElementById('mainImageData');
    const cropMainImageBtn = document.getElementById('cropMainImage');

    mainImageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(event) {
            mainImagePreview.src = event.target.result;
            mainImageContainer.style.display = 'block';
            mainImageCroppedContainer.style.display = 'none';
            
            if (mainCropper) mainCropper.destroy();
            
            mainCropper = new Cropper(mainImagePreview, {
                aspectRatio: 1,
                viewMode: 1,
                autoCropArea: 1,
                movable: true,
                zoomable: true
            });
        };
        reader.readAsDataURL(file);
    });

    cropMainImageBtn.addEventListener('click', function() {
        if (!mainCropper) return;
        
        const canvas = mainCropper.getCroppedCanvas({
            width: 800,
            height: 800,
            minWidth: 256,
            minHeight: 256,
            maxWidth: 4096,
            maxHeight: 4096,
            fillColor: '#fff',
            imageSmoothingEnabled: true,
            imageSmoothingQuality: 'high',
        });
        
        mainImageCroppedPreview.src = canvas.toDataURL('image/jpeg', 0.8);
        mainImageData.value = canvas.toDataURL('image/jpeg', 0.8);
        
        mainImageContainer.style.display = 'none';
        mainImageCroppedContainer.style.display = 'block';
    });

    // Function to initialize other image croppers
    function initializeOtherImageCropper(index) {
        let otherCropper = null;
        const input = document.getElementById(`otherImageInput${index}`);
        const preview = document.getElementById(`otherImagePreview${index}`);
        const container = document.getElementById(`otherImageContainer${index}`);
        const croppedContainer = document.getElementById(`otherImageCroppedContainer${index}`);
        const croppedPreview = document.getElementById(`otherImageCroppedPreview${index}`);
        const imageData = document.getElementById(`otherImageData${index}`);
        const cropBtn = document.getElementById(`cropOtherImage${index}`);

        input.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                preview.src = event.target.result;
                container.style.display = 'block';
                croppedContainer.style.display = 'none';
                
                if (otherCropper) otherCropper.destroy();
                
                otherCropper = new Cropper(preview, {
                    aspectRatio: 1,
                    viewMode: 1,
                    autoCropArea: 1,
                    movable: true,
                    zoomable: true
                });
            };
            reader.readAsDataURL(file);
        });

        cropBtn.addEventListener('click', function() {
            if (!otherCropper) return;
            
            const canvas = otherCropper.getCroppedCanvas({
                width: 800,
                height: 800,
                minWidth: 256,
                minHeight: 256,
                maxWidth: 4096,
                maxHeight: 4096,
                fillColor: '#fff',
                imageSmoothingEnabled: true,
                imageSmoothingQuality: 'high',
            });
            
            croppedPreview.src = canvas.toDataURL('image/jpeg', 0.8);
            imageData.value = canvas.toDataURL('image/jpeg', 0.8);
            
            container.style.display = 'none';
            croppedContainer.style.display = 'block';
        });
    }

    // Initialize other image croppers
    initializeOtherImageCropper(1);
    initializeOtherImageCropper(2);
    initializeOtherImageCropper(3);

    // Form submission
    document.getElementById('productForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validate main image
        if (!mainImageData.value) {
            alert('Please crop the main image before submitting.');
            return;
        }
        
        const form = new FormData(this);
        
        // Convert data URLs to blobs for each cropped image
        const appendImageBlob = (dataUrl, fieldName) => {
            if (dataUrl) {
                fetch(dataUrl)
                    .then(res => res.blob())
                    .then(blob => {
                        const file = new File([blob], `${fieldName}.jpg`, { type: 'image/jpeg' });
                        form.append(fieldName, file);
                    });
            }
        };
        
        // Create a promise for each image conversion
        const imagePromises = [];
        
        if (mainImageData.value) {
            imagePromises.push(
                fetch(mainImageData.value)
                    .then(res => res.blob())
                    .then(blob => {
                        const file = new File([blob], 'main_image.jpg', { type: 'image/jpeg' });
                        form.append('main_image', file);
                    })
            );
        }
        
        // Add other images if they exist
        const otherImagePromises = [1, 2, 3].map(index => {
            const dataUrl = document.getElementById(`otherImageData${index}`).value;
            if (dataUrl) {
                return fetch(dataUrl)
                    .then(res => res.blob())
                    .then(blob => {
                        const file = new File([blob], `other_image_${index}.jpg`, { type: 'image/jpeg' });
                        form.append(`other_image_${index}`, file);
                    });
            }
            return Promise.resolve();
        });
        
        imagePromises.push(...otherImagePromises);
        
        // When all image conversions are done, submit the form
        Promise.all(imagePromises)
            .then(() => {
                fetch("{% url 'customadmin:add_product' %}", {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: form
                })
                .then(response => {
                    if (response.redirected) {
                        window.location.href = response.url;
                    } else {
                        return response.json();
                    }
                })
                .then(data => {
                    if (data) {
                        console.log("Server Response:", data);
                        if (data.status === 'success') {
                            // Redirect to product list page on success
                            window.location.href = data.redirect_url;
                        } else {
                            // Show error message
                            const responseDiv = document.getElementById('responseMessage');
                            responseDiv.innerHTML = `
                                <div class="alert alert-danger mt-3">${data.message}</div>
                            `;
                        }
                    }
                })
                .catch(error => {
                    const responseDiv = document.getElementById('responseMessage');
                    responseDiv.innerHTML = `
                        <div class="alert alert-danger mt-3">An error occurred: ${error.message}</div>
                    `;
                    console.error('Submission error:', error);
                });
            });
    });
</script>
{% endblock %}