{% extends 'admin_base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid mt-4">
  <!-- Debug Section (Remove later) -->
  <div class="alert alert-info">
    Showing {{ products|length }} of {{ products.paginator.count }} products
  </div>

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">

    
    <h2>Product Management</h2> 

    <a href="{% url 'customadmin:add_product' %}" class="btn btn-success">
      <i class="fas fa-plus me-2"></i>Add Product
    </a>
  </div>  

  <!-- Search and Filters -->
  <div class="row mb-3">
    <div class="col-md-6">
      <form method="GET" class="d-flex">
        <input type="text" name="search" class="form-control me-2" 
               placeholder="Search products..." value="{{ request.GET.search }}">
        <button type="submit" class="btn btn-outline-primary me-2">Search</button>
      <a href="{% url 'customadmin:category_list' %}" class="btn btn-outline-secondary">Reset</a>
      </form>
    </div>
    <div class="col-md-6 text-end">
      <div class="btn-group">
        <a href="?sort=price_desc" class="btn btn-outline-dark {% if request.GET.sort == 'price_desc' %}active{% endif %}">
          Price High-Low
        </a>
        <a href="?sort=price_asc" class="btn btn-outline-dark {% if request.GET.sort == 'price_asc' %}active{% endif %}">
          Price Low-High
        </a>        
      </div>
    </div>
  </div>

  <!-- Product Table -->
  <div class="table-responsive">
    <table class="table table-bordered align-middle">
      <thead class="table-light">
        <tr class="text-center">
          <th style="width: 100px;">Image</th>
          <th>Product Name</th>
          <th>Category</th>
          <th>Price</th>
          <th>Stock</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for product in products %}
        <tr>
          <td class="text-center">
            {% if product.thumbnail %}
              <img src="{{ product.thumbnail.url }}" class="table-img img-thumbnail">
            {% else %}
              <div class="table-img bg-light d-flex align-items-center justify-content-center">
                <i class="fas fa-camera text-muted"></i>
              </div>
            {% endif %}
          </td>
          <td>{{ product.name }}</td>
          <td>{{ product.category.name|default:"-" }}</td>
     <td class="text-end">â‚¹{{ product.total_price|default:"0" }}</td>
 
          <td class="text-center">{{ product.total_stock }}</td>
          <td class="text-center">
           <div class="form-check form-switch d-inline-block">
<button type="button"
        class="btn {% if product.is_listed %}btn-success{% else %}btn-danger{% endif %} btn-sm toggle-product-btn"
        data-bs-toggle="modal"
        data-bs-target="#confirmProductToggleModal"
        data-url="{% url 'customadmin:toggle_product_status' product.id %}"
        data-action="{% if product.is_listed %}Unlist{% else %}List{% endif %}">
  {% if product.is_listed %}Unlist{% else %}List{% endif %}
</button>

  <label class="form-check-label"></label>
</div>

          </td>
        
<div class="modal fade" id="confirmProductToggleModal" tabindex="-1" aria-labelledby="confirmProductToggleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmProductToggleModalLabel">Confirm Product Status Change</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to <span id="product-toggle-action-name" class="fw-bold text-capitalize"></span> this product?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <a href="#" class="btn btn-primary" id="confirmProductToggleBtn">Yes, Proceed</a>
      </div>
    </div>
  </div>
</div>
  <td class="text-center">
            <div class="btn-group btn-group-sm">


<a href="{% url 'customadmin:edit_product' product.id %}" class="btn btn-outline-secondary btn-sm"><i class="bi bi-pencil"></i></a> 


<a href="{% url 'customadmin:soft_delete_product' product.id %}"  
   class="btn btn-sm btn-outline-danger bi bi-trash deactivate-product"     
   data-bs-toggle="modal" 
   data-bs-target="#confirmDeleteModal" 
   data-product-id="{{ product.id }}" 
   data-bs-toggle="tooltip" 
   title="Deactivate">
   <i class="fas fa-ban"></i>
</a>

<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmDeleteModalLabel">Confirm Deactivation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to deactivate this product? This action can be undone later.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <a id="confirmDeleteBtn" href="#" class="btn btn-danger">Confirm</a>
            </div>
        </div>
    </div>
</div>
      </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="7" class="text-center py-4">
            <div class="alert alert-warning mb-0">
              No products found. <a href="{% url 'customadmin:add_product' %}" class="alert-link">Add your first product</a>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  {% if products.has_other_pages %}
  <nav aria-label="Page navigation">
    <ul class="pagination justify-content-center mt-4">
      {% if products.has_previous %}
      <li class="page-item">
        <a class="page-link" 
           href="?page={{ products.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}">
          &laquo; Previous
        </a>
      </li>
      {% else %}
      <li class="page-item disabled">
        <span class="page-link">&laquo; Previous</span>
      </li>
      {% endif %}

      {% for num in products.paginator.page_range %}
        {% if products.number == num %}
        <li class="page-item active">
          <span class="page-link">{{ num }}</span>
        </li>
        {% else %}
        <li class="page-item">
          <a class="page-link" 
             href="?page={{ num }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}">
            {{ num }}
          </a>
        </li>
        {% endif %}
      {% endfor %}

      {% if products.has_next %}
      <li class="page-item">
        <a class="page-link" 
           href="?page={{ products.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}">
          Next &raquo;
        </a>
      </li>
      {% else %}
      <li class="page-item disabled">
        <span class="page-link">Next &raquo;</span>
      </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>
<!-- {% endblock %} -->

{% block extra_js %}


<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmDeleteModalLabel">Confirm Deactivation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to deactivate this product?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <a href="#" id="confirmDeleteBtn" class="btn btn-danger">Deactivate</a>
      </div>
    </div>
  </div>
</div>

<!-- 
<script>
document.addEventListener('DOMContentLoaded', function () {
  // === Soft Delete Modal ===
  const confirmDeleteModal = document.getElementById('confirmDeleteModal');
  const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

  if (confirmDeleteModal && confirmDeleteBtn) {
    confirmDeleteModal.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      const productId = button.getAttribute('data-product-id');
      const url = `/admin/products/${productId}/soft_delete/`;
      confirmDeleteBtn.setAttribute('href', url);
    });
  }

  // === Product Toggle Modal ===
  const confirmModal = document.getElementById('confirmProductToggleModal');
  if (confirmModal) {
    confirmModal.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      const url = button.getAttribute('data-url');
      const action = button.getAttribute('data-action');

      const confirmBtn = confirmModal.querySelector('#confirmProductToggleBtn');
      const actionSpan = confirmModal.querySelector('#product-toggle-action-name');

      if (confirmBtn && actionSpan) {
        confirmBtn.href = url;
        actionSpan.textContent = action;
      }
    });
  }

  // === Bootstrap Tooltips ===
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
});
</script> -->


<script>
document.addEventListener('DOMContentLoaded', function () {
  var confirmModal = document.getElementById('confirmToggleModal');
  confirmModal.addEventListener('show.bs.modal', function (event) {
    var button = event.relatedTarget;
    var url = button.getAttribute('data-url');
    var action = button.getAttribute('data-action');

    var confirmBtn = confirmModal.querySelector('#confirmToggleBtn');
    var actionSpan = confirmModal.querySelector('#toggle-action-name');

    confirmBtn.href = url;
    actionSpan.textContent = action;
  });
});
</script>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        var deleteLinks = document.querySelectorAll('[data-bs-toggle="modal"]');

        deleteLinks.forEach(function(link) {
            link.addEventListener('click', function(event) {
                var categoryId = link.getAttribute('data-category-id');
                var confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

                var url = '{% url "customadmin:soft_delete_category" 0 %}'.replace('0', categoryId);
                confirmDeleteBtn.setAttribute('href', url);
            });
        });
    });
</script>
 

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

{%endblock%}

