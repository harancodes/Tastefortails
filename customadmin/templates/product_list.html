{% extends 'admin_base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid mt-4">
  <!-- Debug Section (Remove later) -->
  <div class="alert alert-info">
    Showing {{ products|length }} of {{ products.paginator.count }} products
  </div>

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Product Management</h2>
    <a href="{% url 'add_product' %}" class="btn btn-success">
      <i class="fas fa-plus me-2"></i>Add Product
    </a>
  </div>

  <!-- Search and Filters -->
  <div class="row mb-3">
    <div class="col-md-6">
      <form method="GET" class="d-flex">
        <input type="text" name="search" class="form-control me-2" 
               placeholder="Search products..." value="{{ request.GET.search }}">
        <button class="btn btn-primary" type="submit">
          <i class="fas fa-search"></i>
        </button>
      </form>
    </div>
    <div class="col-md-6 text-end">
      <div class="btn-group">
        <a href="?sort=price_desc" class="btn btn-outline-dark {% if request.GET.sort == 'price_desc' %}active{% endif %}">
          Price High-Low
        </a>
        <a href="?sort=price_asc" class="btn btn-outline-dark {% if request.GET.sort == 'price_asc' %}active{% endif %}">
          Price Low-High
        </a>
        <a href="?sort=latest" class="btn btn-outline-dark {% if request.GET.sort == 'latest' %}active{% endif %}">
          Newest First
        </a>
      </div>
    </div>
  </div>

  <!-- Product Table -->
  <div class="table-responsive">
    <table class="table table-bordered align-middle">
      <thead class="table-light">
        <tr class="text-center">
          <th style="width: 100px;">Image</th>
          <th>Product Name</th>
          <th>Category</th>
          <th>Price</th>
          <th>Stock</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for product in products %}
        <tr>
          <td class="text-center">
            {% if product.thumbnail %}
              <img src="{{ product.thumbnail.url }}" class="table-img img-thumbnail">
            {% else %}
              <div class="table-img bg-light d-flex align-items-center justify-content-center">
                <i class="fas fa-camera text-muted"></i>
              </div>
            {% endif %}
          </td>
          <td>{{ product.name }}</td>
          <td>{{ product.category.name|default:"-" }}</td>
          <td class="text-end">â‚¹{{ product.price|default:"0" }}</td>
          <td class="text-center">{{ product.stock }}</td>
          <td class="text-center">
            <span class="badge {% if product.is_active %}bg-success{% else %}bg-danger{% endif %}">
              {% if product.is_active %}Active{% else %}Inactive{% endif %}
            </span>
          </td>
          <td class="text-center">
            <div class="btn-group btn-group-sm">
              <a href="{% url 'edit_product' product.id %}" class="btn btn-primary">
                <i class="fas fa-edit"></i>
              </a>
             <!-- Delete Button -->
<a href="{% url 'delete_product' product.id %}" 
   class="btn btn-sm btn-outline-danger"
   onclick="return confirm('Deactivate this product?')"
   data-bs-toggle="tooltip" 
   title="Deactivate">
   <i class="fas fa-ban"></i>
</a>

<!-- Toggle Switch -->
<div class="form-check form-switch d-inline-block">
  <input class="form-check-input status-toggle" 
         type="checkbox" 
         data-product-id="{{ product.id }}"
         {% if product.is_active %}checked{% endif %}>
  <label class="form-check-label"></label>
</div>
 
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="7" class="text-center py-4">
            <div class="alert alert-warning mb-0">
              No products found. <a href="{% url 'add_product' %}" class="alert-link">Add your first product</a>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  {% if products.has_other_pages %}
  <nav aria-label="Page navigation">
    <ul class="pagination justify-content-center mt-4">
      {% if products.has_previous %}
      <li class="page-item">
        <a class="page-link" 
           href="?page={{ products.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}">
          &laquo; Previous
        </a>
      </li>
      {% else %}
      <li class="page-item disabled">
        <span class="page-link">&laquo; Previous</span>
      </li>
      {% endif %}

      {% for num in products.paginator.page_range %}
        {% if products.number == num %}
        <li class="page-item active">
          <span class="page-link">{{ num }}</span>
        </li>
        {% else %}
        <li class="page-item">
          <a class="page-link" 
             href="?page={{ num }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}">
            {{ num }}
          </a>
        </li>
        {% endif %}
      {% endfor %}

      {% if products.has_next %}
      <li class="page-item">
        <a class="page-link" 
           href="?page={{ products.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}">
          Next &raquo;
        </a>
      </li>
      {% else %}
      <li class="page-item disabled">
        <span class="page-link">Next &raquo;</span>
      </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
